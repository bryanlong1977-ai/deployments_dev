# GitHub Actions Workflow for Landing Zone Terraform Deployment
# This is a SHARED workflow - use inputs to deploy ANY topology instance
# Examples: hub-spoke-primary, hub-spoke-secondary, vwan-primary, etc.
# Generated by CloudCraft AI

name: Landing Zone Terraform Apply

on:
  workflow_dispatch:
    inputs:
      topology_instance:
        description: 'Topology Instance (e.g., hub-spoke-primary, hub-spoke-secondary)'
        required: true
        type: choice
        options:
          - hub-spoke-primary
          - hub-spoke-secondary
          - hub-spoke-dr
          - vwan-primary
          - vwan-secondary
        default: 'hub-spoke-primary'
      
      subscription_type:
        description: 'Subscription Type'
        required: true
        type: choice
        options:
          - connectivity
          - identity
          - management
          - dns
          - dmz
          - workload
          - shared
        default: 'connectivity'
      
      deployment_name:
        description: 'Deployment Name (folder name)'
        required: true
        type: choice
        options:
          - network-deployment-1
          - tools-deployment-1
          - tools-deployment-2
          - network-deployment-2
          - nsg-deployment-1
          - route-table-deployment-1
        default: 'network-deployment-1'
      
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - production
          - staging
          - development
        default: 'production'
      
      auto_approve:
        description: 'Auto-approve apply (skip manual approval)'
        required: false
        type: boolean
        default: false

env:
  TF_VERSION: '1.5.0'
  WORKING_DIR: 'landingzone/${{ github.event.inputs.topology_instance }}/${{ github.event.inputs.subscription_type }}/${{ github.event.inputs.deployment_name }}'

jobs:
  validate:
    name: 'Terraform Validate'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -input=false
        env:
          ARM_USE_OIDC: true
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      
      - name: Terraform Validate
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform validate

  plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -input=false
        env:
          ARM_USE_OIDC: true
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      
      - name: Terraform Plan
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform plan  -input=false -out=tfplan
        env:
          ARM_USE_OIDC: true
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.topology_instance }}-${{ github.event.inputs.subscription_type }}-${{ github.event.inputs.deployment_name }}
          path: ${{ env.WORKING_DIR }}/tfplan
          retention-days: 5

  approval:
    name: '✋ Manual Approval'
    runs-on: ubuntu-latest
    needs: plan
    if: ${{ github.event.inputs.auto_approve != 'true' }}
    environment: '${{ github.event.inputs.environment }}-approval'
    steps:
      - name: Approval Gate
        run: |
          echo "=========================================="
          echo "✅ Deployment approved"
          echo "Topology: ${{ github.event.inputs.topology_instance }}"
          echo "Subscription: ${{ github.event.inputs.subscription_type }}"
          echo "Deployment: ${{ github.event.inputs.deployment_name }}"
          echo "Action: Apply"
          echo "=========================================="

  apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    needs: [plan, approval]
    if: ${{ always() && needs.plan.result == 'success' && (needs.approval.result == 'success' || needs.approval.result == 'skipped') }}
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.topology_instance }}-${{ github.event.inputs.subscription_type }}-${{ github.event.inputs.deployment_name }}
          path: ${{ env.WORKING_DIR }}
      
      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -input=false
        env:
          ARM_USE_OIDC: true
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      
      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -input=false -auto-approve tfplan
        env:
          ARM_USE_OIDC: true
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
